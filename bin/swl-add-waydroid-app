#!/bin/bash
# SteamWaydroidLauncher - Add Waydroid app to Steam

WAYDROID_DESKTOP_DIR="$HOME/.local/share/applications"
SWL_DESKTOP_DIR="$HOME/.local/share/swl/applications"

mkdir -p "$SWL_DESKTOP_DIR"

# Find all Waydroid .desktop files (including Waydroid.desktop)
mapfile -t desktop_files < <(find "$WAYDROID_DESKTOP_DIR" -maxdepth 1 \( -name 'waydroid.*.desktop' -o -name 'Waydroid.desktop' \))

if [ ${#desktop_files[@]} -eq 0 ]; then
    kdialog --error "No Waydroid apps found!"
    exit 1
fi

# Prepare list for kdialog: package|name|file
entries=()
for file in "${desktop_files[@]}"; do
    name=$(grep -m1 '^Name=' "$file" | cut -d= -f2-)
    if [[ "$(basename "$file")" == "Waydroid.desktop" ]]; then
        package="Waydroid"
    else
        # Extract package name from Exec line
        package=$(grep -m1 '^Exec=' "$file" | sed -n 's/.*launch\s\+\([^ ]*\).*/\1/p')
        # Fallback to filename if extraction fails
        if [[ -z "$package" ]]; then
            package=$(basename "$file" .desktop | cut -d. -f2-)
        fi
    fi
    entries+=("$package|$name|$file")
done

# Sort alphabetically by name
IFS=$'\n' sorted_entries=($(printf "%s\n" "${entries[@]}" | sort -t'|' -k2,2))
entries=("${sorted_entries[@]}")

# kdialog radiolist: ID Label off
dialog_args=()
for entry in "${entries[@]}"; do
    IFS='|' read -r package name file <<< "$entry"
    dialog_args+=("$package" "$name" "off")
done

choice=$(kdialog --radiolist "Select a Waydroid app:" "${dialog_args[@]}")

[ -z "$choice" ] && exit 0

# Find the selected file
for entry in "${entries[@]}"; do
    IFS='|' read -r package name file <<< "$entry"
    if [[ "$package" == "$choice" ]]; then
        selected_file="$file"
        selected_name="$name"
        break
    fi
done

icon=$(grep -m1 '^Icon=' "$selected_file" | cut -d= -f2-)

# Special case for Waydroid.desktop
if [[ "$(basename "$selected_file")" == "Waydroid.desktop" ]]; then
    exec_cmd="swl-launcher"
else
    exec_cmd="swl-launcher app launch $choice"
fi

# Create new .desktop file
swl_desktop="$SWL_DESKTOP_DIR/swl.$choice.desktop"
if ! cat > "$swl_desktop" <<EOF
[Desktop Entry]
Type=Application
Name=$selected_name (Waydroid)
Exec=$exec_cmd
Icon=$icon
Categories=X-WayDroid-App;
EOF
then
    kdialog --error "Failed to create desktop file: $swl_desktop"
    exit 1
fi

# Make the desktop file executable
chmod +x "$swl_desktop"

steamos-add-to-steam "$swl_desktop" 2>/dev/null || {
    echo "Note: steamos-add-to-steam not found. Please manually add $swl_desktop to Steam."
    echo "You can find the desktop file at: $swl_desktop"
}

if command -v steamos-add-to-steam >/dev/null 2>&1; then
    kdialog --msgbox "App '$selected_name (Waydroid)' was added to Steam!"
else
    kdialog --msgbox "Desktop file created: $swl_desktop\n\nTo add to Steam:\n1. Open Steam\n2. Games â†’ Add Non-Steam Game\n3. Browse to: $swl_desktop"
fi

exit 0