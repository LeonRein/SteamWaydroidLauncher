#!/bin/bash

SUDOERS_DST="/etc/sudoers.d/99-swl"
USERNAME="$(whoami)"

# Prevent running as root
if [ "$(id -u)" -eq 0 ]; then
    echo "ERROR: Do not run this script as root. Please run as a regular user."
    exit 1
fi

# Check if the sudoers file exists (as root)
if ! sudo test -f "$SUDOERS_DST"; then
    echo "No sudoers file found at $SUDOERS_DST"
    exit 0
fi

# Remove only the lines for the current user
sudo grep -v "^$USERNAME " "$SUDOERS_DST" | sudo tee "$SUDOERS_DST.tmp" > /dev/null
sudo mv "$SUDOERS_DST.tmp" "$SUDOERS_DST"
sudo chmod 440 "$SUDOERS_DST"

# Check if any entries remain; if not, remove the file
if ! sudo grep -q "ALL=(ALL) NOPASSWD:" "$SUDOERS_DST"; then
    sudo rm "$SUDOERS_DST"
    echo "All sudoers entries removed; deleted $SUDOERS_DST"
else
    echo "Removed sudoers entry for user $USERNAME from $SUDOERS_DST"
fi