#!/bin/bash

# Prevent running as root
if [ "$(id -u)" -eq 0 ]; then
    echo "ERROR: Do not run this script as root. Please run as a regular user."
    exit 1
fi

if [ -z "$LOGFILE" ]; then
    source /usr/lib/swl/setup-logging.sh
fi

export RESOLUTION=$(xrandr | awk '/\*/{print $1; exit}')

echo "[$(date)] Starting Waydroid launch script with resolution: $RESOLUTION"

trap /usr/bin/swl-shutdown-waydroid EXIT

cage -- bash -c "wlr-randr --output X11-1 --custom-mode $RESOLUTION ; \
    /usr/bin/swl-startup-waydroid $1"

trap - EXIT
/usr/bin/swl-shutdown-waydroid