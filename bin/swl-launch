#!/bin/bash

LOGFILE="/var/log/swl.log"
# Ensure the log file exists and is writable
sudo touch "$LOGFILE"
sudo chown "$(whoami)" "$LOGFILE"
exec >> "$LOGFILE" 2>&1

echo "[$(date)] Starting swl-launch..."

export RESOLUTION=$(xdpyinfo | awk '/dimensions/{print $2}')

# Check if non Steam shortcut has the game / app as the launch option
if [ -z "$1" ]
then
    # launch option not provided. launch Waydroid via cage and show the full ui right away
    cage -- bash -c 'wlr-randr --output X11-1 --custom-mode $RESOLUTION ; \
        sudo /usr/bin/waydroid-startup-scripts ; \
        /usr/bin/waydroid show-full-ui &'
else
    # launch option provided. launch Waydroid via cage but do not show full ui, launch the app from the arguments, then launch the full ui so it doesnt crash when exiting the app provided
    cage -- env PACKAGE="$1" bash -c 'wlr-randr --output X11-1 --custom-mode $RESOLUTION ; \
        sudo /usr/bin/waydroid-startup-scripts ; \

        sleep 1 ; \
        /usr/bin/waydroid app launch $PACKAGE & \

        sleep 1 ; \
        /usr/bin/waydroid show-full-ui &'
fi

trap 'sudo /usr/bin/waydroid-shutdown-scripts' EXIT

# run shutdown scripts to cleanup when waydroid exits
while [ -n "$(pgrep cage)" ]
do
    sleep 1
done

echo "[$(date)] swl-launch completed."
